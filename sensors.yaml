# Template Sensors
- sensor:
    - name: "Toilet Heater Countdown"
      unique_id: "toilet_heater_countdown"
      state: >
        {% set switch = states('switch.standing_lamp_socket_1') %}
        {% set power = states('sensor.standing_lamp_power') | float(0) %}
        {% if switch == 'on' or power > 1 %}
          {% set last_changed = state_attr('switch.standing_lamp_socket_1', 'last_changed') %}
          {% if last_changed %}
            {% set elapsed = (as_timestamp(now()) - as_timestamp(last_changed)) | int %}
            {% set remaining = 300 - elapsed %}
            {% if remaining > 0 %}
              {% set minutes = (remaining // 60) | int %}
              {% set seconds = (remaining % 60) | int %}
              {{ "%02d:%02d" | format(minutes, seconds) }}
            {% else %}
              00:00
            {% endif %}
          {% else %}
            05:00
          {% endif %}
        {% else %}
          Off
        {% endif %}
      icon: >
        {% if states('switch.standing_lamp_socket_1') == 'on' or states('sensor.standing_lamp_power') | float(0) > 1 %}
          mdi:timer
        {% else %}
          mdi:timer-off
        {% endif %}
      unit_of_measurement: ""

    # Frigate License Plate Recognition Counts
    # Counts occurrences of each license plate from history
    - name: "Frigate License Plate Counts"
      unique_id: "frigate_license_plate_counts"
      state: >
        {% set window_history = states('sensor.window_last_recognized_plate') | history(count=1000) %}
        {% set eufy_history = states('sensor.eufy_last_recognized_plate') | history(count=1000) %}
        {% set plate_counts = {} %}
        
        {% for state in window_history %}
          {% set plate = state.state %}
          {% if plate and plate not in ['None', 'Unknown', 'unknown', '', 'unavailable'] %}
            {% if plate in plate_counts %}
              {% set _ = plate_counts.update({plate: plate_counts[plate] + 1}) %}
            {% else %}
              {% set _ = plate_counts.update({plate: 1}) %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% for state in eufy_history %}
          {% set plate = state.state %}
          {% if plate and plate not in ['None', 'Unknown', 'unknown', '', 'unavailable'] %}
            {% if plate in plate_counts %}
              {% set _ = plate_counts.update({plate: plate_counts[plate] + 1}) %}
            {% else %}
              {% set _ = plate_counts.update({plate: 1}) %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% set sorted_plates = plate_counts.items() | sort(attribute=1, reverse=true) | list %}
        {% set top_10 = sorted_plates[:10] | list %}
        
        {% if top_10 | length > 0 %}
          {{ top_10 | map(attribute=0) | join(', ') }}
        {% else %}
          No plates detected
        {% endif %}
      attributes:
        plates: >
          {% set window_history = states('sensor.window_last_recognized_plate') | history(count=1000) %}
          {% set eufy_history = states('sensor.eufy_last_recognized_plate') | history(count=1000) %}
          {% set plate_counts = {} %}
          
          {% for state in window_history %}
            {% set plate = state.state %}
            {% if plate and plate not in ['None', 'Unknown', 'unknown', '', 'unavailable'] %}
              {% if plate in plate_counts %}
                {% set _ = plate_counts.update({plate: plate_counts[plate] + 1}) %}
              {% else %}
                {% set _ = plate_counts.update({plate: 1}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% for state in eufy_history %}
            {% set plate = state.state %}
            {% if plate and plate not in ['None', 'Unknown', 'unknown', '', 'unavailable'] %}
              {% if plate in plate_counts %}
                {% set _ = plate_counts.update({plate: plate_counts[plate] + 1}) %}
              {% else %}
                {% set _ = plate_counts.update({plate: 1}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% set sorted_plates = plate_counts.items() | sort(attribute=1, reverse=true) | list %}
          {% set top_10 = sorted_plates[:10] | list %}
          
          {% set result = [] %}
          {% for plate, count in top_10 %}
            {% set _ = result.append({'plate': plate, 'count': count}) %}
          {% endfor %}
          {{ result }}
      icon: mdi:car-multiple

